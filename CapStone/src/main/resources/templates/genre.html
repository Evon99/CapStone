<!DOCTYPE html>
<html 	xmlns:th="http://www.thymeleaf.org"		
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layouts/layout}">

<th:block layout:fragment="script">
	<script th:inline="javascript">
		
	$(document).ready(function() {
        // 서버에서 받은 추천한 음악 ID 목록
        var likedMusicIds = /*[[${likedMusicIds}]]*/ [];

        console.log(likedMusicIds)

        // 이미지 클릭 시 동작
        $('.main-top-music-function-like').click(function() {
            var musicId = $(this).data('music-id');
            
            console.log("musicId");
            // 이미 추천한 경우 이미지 변경하지 않음
            if (likedMusicIds.includes(musicId)) {
                alert('이미 추천한 음악입니다.');
                return;
            }

            // TODO: 서버에 좋아요 업데이트 요청 등 추가 동작 수행
            // 클라이언트 측에서 이미지 변경
            $(this).attr('src', '/static/images/like_on.png');
            // likedMusicIds에 추가
            likedMusicIds.push(musicId);
        });

        // 서버에서 받은 추천한 음악 ID 목록에 따라 이미지 변경
        likedMusicIds.forEach(function(musicId) {
            $('img[data-music-id="' + musicId + '"]').attr('src', '/static/images/like_on.png');
        });
    });
	
	    function likeMusic(musicId) {
	    	// 이미 좋아요를 눌렀는지 확인
	       

	        // AJAX를 사용하여 서버에 좋아요 수 업데이트 요청
	        $.ajax({
	            type: 'POST',
	            url: '/like/' + musicId,
	            dataType: 'json',
	            success: function (updatedLikeCount) {
	                // 성공적으로 업데이트된 좋아요 수를 받아와 화면 갱신
	                $('#likeCount').text(updatedLikeCount);
	                
	                // 로컬 스토리지에 좋아요 눌렀음을 표시
	                localStorage.setItem(`like_${musicId}`, 'true');
	            },
	            error: function (xhr) {
	            }
	        });
	    }
	    
	    function ModaltoggleFollow(element) {
		    var nickname = element.getAttribute('data-nickname');
		    var loginNickname = element.getAttribute('data-login-nickname');

		    $.ajax({
		        type: 'POST',
		        url: '/toggleFollow',
		        data: {
		            nickname: nickname,
		            loginNickname: loginNickname
		        },
		        success: function(response) {
		            console.log(response);
		            if (response === 'Followed' || response === 'Unfollowed') {
		                document.getElementById('SearchfollowButton').textContent = (response === 'Followed') ? '팔로잉' : '팔로우';
		                document.getElementById('SearchfollowButton').style.backgroundColor = (response === 'Followed') ? '#ccc' : '#66c';
		                document.getElementById('SearchfollowButton').style.border = (response === 'Followed') ? '1px solid #ccc' : '1px solid #6c';
		                document.getElementById('SearchfollowButton').style.color = (response === 'Followed') ? 'black' : 'white';
		            }
		        },
		        error: function(error) {
		            console.error(error);
		        }
		    });
		}
	</script>

</th:block>

<head>
<div layout:fragment="head">
    <meta charset="utf-8" />
    <meta content="SearchResult" property="og:title" />
    <meta content="SearchResult" property="twitter:title" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta content="Webflow" name="generator" />
    <link
        th:href="@{/css/styles.css}"
        rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous" />
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
    <script
        type="text/javascript">WebFont.load({ google: { families: ["Open Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic", "Exo:100,100italic,200,200italic,300,300italic,400,400italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic", "Roboto:300,regular,500", "Roboto Condensed:300,regular,700", "Roboto Slab:300,regular,700", "Arbutus Slab:regular"] } });</script>
    <script
        type="text/javascript">!function (o, c) { var n = c.documentElement, t = " w-mod-"; n.className += t + "js", ("ontouchstart" in o || o.DocumentTouch && c instanceof DocumentTouch) && (n.className += t + "touch") }(window, document);</script>
    <link
        href="https://assets-global.website-files.com/65085ce06a89f83f850a1961/65085ce06a89f83f850a19dc_New%20icon.ico"
        rel="shortcut icon" type="image/x-icon" />
    <link
        href="https://assets-global.website-files.com/65085ce06a89f83f850a1961/65085ce06a89f83f850a19f2_metric-webclip.png"
        rel="apple-touch-icon" />
</div>
</head>

<body>
<div layout:fragment="content" id="content-container">
    <div id="features"  class="main-page-section">
        <div class="w-layout-blockcontainer music-search-container w-container">
            <div class="genre-detail-div-block">
            	<img th:src="${genreImg}"
                    loading="lazy" alt="" class="genre-image" />
                <div class="genre-info-div-block">
                    <div class="genre-name" th:text="${genre}">Rock &amp; Metal</div>
                    <div class="genre-info" th:text="${tracks + '곡 · ' + totalPlayHour + '시간 ' + totalPlayMinutes + '분'}">98곡 · 1시간 25분</div>
                </div>
            </div>
	            
            
            <div th:each="music : ${genreResults}" class="search-foreach-div-block">
	                <div  class="search-music-row w-row" >
	                    <div class="main-top-music-img-column w-col w-col-4">
	                    	<img th:src="${music.imgUrl}"
	                             width="100" height="100"
	                            alt=""  class="main-top-music-img" />
	                        <img th:src="@{/static/images/music_play_button.png}" th:onclick="playMusic(/*[[${music.id}]]*/, /*[[${music.musicUrl}]]*/, /*[[${music.imgUrl}]]*/, /*[[${music.aiSinger}]]*/, /*[[${music.title}]]*/, /*[[${music.oriSinger}]]*/, /*[[${music.memberDetail.nickname}]]*/); showFooter()"
    							loading="lazy" alt="" class="play-button-img" /></div>
	                    <div class="main-top-music-detail-column w-col w-col-4">
	                        <h4 class="main-top-music-title" th:text="${music.aiSinger + ' - ' + music.title + '(' + music.oriSinger + ')'}">AI 가수 - Title(원작자)</h4>
	                        <p class="main-top-music-uploader" th:text="${music.uploaderNickname}">Uploader</p>
	                        <div class="current-div-block">
	                        	<img th:src="@{/static/images/like.png}" loading="lazy" width="24" alt="" class="main-top-music-show-like-img" />
	                            <div class="main-top-music-show-like-text" th:id="'likeCount' + ${music.id}" th:text="${music.like}">55.3k</div>
	                        </div>
	                    </div>
	                    <div class="main-top-music-last-column w-col w-col-4">
	                        <div class="main-top-music-function-columns w-row">
	                            <div class="main-top-music-function-like-column w-col w-col-4">
	                            	<img th:src="@{/static/images/like.png}" loading="lazy"  
	                            		th:attr="data-like-music-id=${music.id}, data-like-music-ids=${likeMusicIds}" onclick="likeMusic(this)" alt="" class="main-top-music-function-like" /></div>
	                            <div class="main-top-music-function-addsong-column w-col w-col-4">
	                            	<img th:src="@{/static/images/add_song.png}" loading="lazy"  alt=""
	                                    th:attr="data-add-music-id=${music.id}, data-add-music-ids=${addMusicIds}" onclick="addMusic(this)" class="main-top-music-function-addsong" /></div>
	                            <div class="main-top-music-function-report-column w-col w-col-4"><a href="#"
	                                    class="main-report-link-block w-inline-block">
	                                <img th:src="@{/static/images/report.png}" loading="lazy"  alt=""
	                                        class="main-top-music-function-report" /></a></div>
	                        </div>
	                    </div>
	                </div>
	         </div>
            
            
        </div>
    </div>
</div>
</body>

</html>