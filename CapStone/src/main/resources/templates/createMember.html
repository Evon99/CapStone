<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layouts/layout}"
	  
    >

<!-- 사용자 스크립트 추가 -->
<th:block layout:fragment="script">

  <script th:inline="javascript">
  
		  window.onload = function() {
		      // 이미지가 로드된 후에 실행될 코드
		      displayDefaultImage();
		  };
		  
		  $(document).ready(function(){
		  	console.log("에레 메서지 출력 실행");
		  	var errorMessage = /*[[${errorMessage}]]*/ '';
		    if(errorMessage != null){
		      alert(errorMessage);
		    }
		    
		    bindDomEvent();
		  });
		  
		  function bindDomEvent() {
			    console.log("bindDomEvent function is called!");
			    $(".custom-file-input").on("change", function () {
			        var fileName = $(this).val().split("\\").pop();  // 이미지 파일명
			        var fileExt = fileName.substring(fileName.lastIndexOf(".") + 1); // 확장자 추출
			        fileExt = fileExt.toLowerCase(); // 소문자 변환

			        

			        // 서버에 이미지 파일 여부 확인 요청
			        var formData = new FormData();
			        formData.append('file', this.files[0]);

			        $.ajax({
			            url: '/checkImage',
			            type: 'POST',
			            data: formData,
			            processData: false,
			            contentType: false,
			            success: function (response) {
			                if (response.isImage) {
			                    // 이미지 파일일 경우 프로필 이미지 변경
			                    displaySelectedImage(response.encodedImage);
			                } else {
			                	displayDefaultImage();
			                    alert("이미지 파일만 등록이 가능합니다.");
			                }
			            },
			            error: function () {
			                alert("서버 오류가 발생했습니다.");
			            }
			        });
			    });
			}

			// 이미지 파일이면 프로필 이미지 변경
			function displaySelectedImage(encodedImage) {
			    const image = document.getElementById("profile");
			    const fileInput = document.getElementById("fileInput");

			    const selectedFile = fileInput.files[0];

			    if (selectedFile) {
			        // 이미지 파일의 Base64 데이터를 이용하여 이미지 변경
			        image.src = 'data:' + selectedFile.type + ';base64,' + encodedImage;
			    }
			}
			
			// 이미지 파일이 아닐 경우 기본 이미지 유지
			function displayDefaultImage() {
			    const image = document.getElementById("profile");
			    const defaultImageSrc = image.getAttribute("data-default-src");
			
			 // 일정 시간이 지난 후에 이미지를 표시
			    setTimeout(function() {
			        image.src = defaultImageSrc;
			    }, 100); // 예: 100 밀리초 후에 실행
			}


			var memberPicture = /*[[${memberPicture}]]*/ '';
  </script>

</th:block>
  
<head>
    <meta charset="utf-8" />
    <div layout:fragment="head">
	    <meta content="LoginForm" property="og:title" />
	    <meta content="LoginForm" property="twitter:title" />
	    <meta content="width=device-width, initial-scale=1" name="viewport" />
	    <meta content="Webflow" name="generator" />
	    <link
	        th:href="@{/css/createMember.css}"
	        rel="stylesheet" type="text/css" />
	    <link href="https://fonts.googleapis.com" rel="preconnect" />
	    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous" />
	    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
	    <script
	        type="text/javascript">WebFont.load({ google: { families: ["Open Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic", "Roboto:300,regular,500", "Roboto Condensed:300,regular,700", "Roboto Slab:300,regular,700", "Arbutus Slab:regular"] } });</script>
	    <script
	        type="text/javascript">!function (o, c) { var n = c.documentElement, t = " w-mod-"; n.className += t + "js", ("ontouchstart" in o || o.DocumentTouch && c instanceof DocumentTouch) && (n.className += t + "touch") }(window, document);</script>
	    <link href="https://uploads-ssl.webflow.com/65085ce06a89f83f850a1961/65085ce06a89f83f850a19dc_New%20icon.ico"
	        rel="shortcut icon" type="image/x-icon" />
	    <link href="https://uploads-ssl.webflow.com/65085ce06a89f83f850a1961/65085ce06a89f83f850a19f2_metric-webclip.png"
	        rel="apple-touch-icon" />
	 </div>
</head>

<div layout:fragment="content">
    <div data-delay="4000" data-animation="slide" class="slider w-slider" data-autoplay="false" data-easing="ease"
        data-hide-arrows="false" data-disable-swipe="false" data-autoplay-limit="0" data-nav-spacing="3"
        data-duration="500" data-infinite="true">
        <div class="w-slider-mask">
            <div class="slide _1 w-slide">
                <div class="w-container"></div>
            </div>
            <div class="slide _2 w-slide">
                <div class="w-container"></div>
            </div>
            <div class="slide _3 w-slide">
                <div class="w-container"></div>
            </div>
        </div>
        <div class="w-slider-arrow-left">
            <div class="w-icon-slider-left"></div>
        </div>
        <div class="w-slider-arrow-right">
            <div class="w-icon-slider-right"></div>
        </div>
        <div class="w-slider-nav w-round"></div>
    </div>
    <div id="features" class="section">
        <div class="w-layout-blockcontainer container-2 w-container">
            <div class="div-block-2">
                <div class="w-form">
                    <form id="email-form" name="email-form"  
                        method="post" class="form" 
                        enctype="multipart/form-data" th:object="${memberDetailDto}">
                        <h2 class="heading-2">Setting Profile</h2>
                        
                        <img th:if="${memberPicture != null}" id="profile" th:src="${memberPicture}" alt="Select picture" class="image-4" th:onclick="fileInput.click()" th:data-default-src="${memberPicture}" th:onerror="this.onerror=null; this.src=memberPicture;"/>
						<img th:unless="${memberPicture != null}" id="profile" th:src="@{/static/images/profile_image.svg}" data-default-src="@{/static/images/profile_image.svg}"  alt="Select picture" class="image-4" th:onclick="fileInput.click()" />


                        <input type="file" name="memberImgFile" id="fileInput" class="custom-file-input" style="display: none;" th:onchange="displaySelectedImage()">
						   
						<!-- Thymeleaf script for handling file input change -->
					    <script th:inline="javascript">
						    
					    
					    </script>
                            <label for="name"
                            class="field-label">Enter your NickName</label><input type="text" th:field="*{nickname}" class="text-field w-input"
                            maxlength="256" name="nickName" data-name="Name" th:value="${memberName}" id="nickname" />
                            <div th:if="${#fields.hasErrors('nickname')}" th:errors="*{nickname}" class="text-block">InCorrect Data</div>
                            <input type="submit" th:formaction="@{/private/profileSetting}" value="Submit" class="submit-button-2 w-button" />
                    </form>
                    <!-- <div class="w-form-done">
                        <div>Thank you! Your submission has been received!</div>
                    </div>
                    <div class="w-form-fail">
                        <div>Oops! Something went wrong while submitting the form.</div>
                    </div> -->
                </div>
            </div>
        </div>
    </div>
    <!-- <div class="section footer copyright">
        <div class="w-container">
            <div>Copyright 2023 Metric. All Rights Reserved. Brand logos for demonstration purposes only.</div>
        </div>
    </div>
    <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=65085ce06a89f83f850a1961"
        type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script> -->
     <!-- <script src="https://uploads-ssl.webflow.com/65085ce06a89f83f850a1961/js/webflow.e857920fc.js"
        type="text/javascript"></script> -->
    <script th:src="@{/js/createMember.js}"
        type="text/javascript"></script>
    <script th:src="@{/js/musicPlay.js}"
        type="text/javascript"></script>
</div>

</html>